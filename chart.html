<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <script type="text/javascript" src="d3/d3.v3.js"></script>
</head>
<body>
<h4>Receiving data</h4>
<script>
  var ws = new WebSocket('ws://localhost:54014');
  console.log('ws client ready!');
  var dataset = [];
  var time = 10;

  // Disconnect the ws client
  function disconnect() {
    ws.close();
    console.log('disconnected!');
    console.log(JSON.stringify(dataset));
    draw();
  }

  window.setTimeout(disconnect, time * 1000);

  ws.onmessage = function(v) {
    var newData = JSON.parse(v.data);
    dataset.push(newData);
    console.log('data list ' + dataset);
  }

  function draw() {
    console.log('drawing...');
    var width = 1100,
        height = 200,
        padding = 20;

    // x-axis : time
    var xScale = d3.scale.linear()
                          .domain([0, dataset.length])
                          //.range([0, width - 100]);
                          .range([padding, (width - 100) - padding]);

    // radius of circle
    var yScale = d3.scale.linear()
                          .domain([0, 100])
                          .range([0, 30]);

    /*
    var xAxis = d3.svg.axis()
                      .scale(xScale)
                      .orient('bottom');
    */

    // Attention
    var svg1 = d3.select('body')
                 .append('svg')
                 .attr('width', width)
                 .attr('height', height);

    console.log('svg ready');

    var attentionCircles = svg1.selectAll('circle')
                              .data(dataset)
                              .enter()
                              .append('circle');

    attentionCircles.attr('cx', function(d, i) {
              //return (i * 100) + 100;
              return xScale(i) + xScale(1) - padding;
           })
           .attr('cy', height/2)
           .attr('r', function(d) {
              //return d['eSense']['attention'];
              return yScale(d['eSense']['attention']);
           });

    // x-axis bar
    svg1.append('g')
        .call(d3.svg.axis()
                    .scale(xScale)
                    .orient('bottom'));

    // Meditation
    var svg2 = d3.select('body')
                 .append('svg')
                 .attr('width', width)
                 .attr('height', height);

    var meditationCircles = svg2.selectAll('circle')
                               .data(dataset)
                               .enter()
                               .append('circle');

    meditationCircles.attr('cx', function(d, i) {
                        //return (i * 100) + 100;
                        return xScale(i) + xScale(1);
                     })
                     .attr('cy', height/2)
                     .attr('r', function(d) {
                        //return d['eSense']['meditation'];
                        return yScale(d['eSense']['meditation']);
                     });

    // x-axis bar
    svg2.append('g')
        .call(d3.svg.axis()
                    .scale(xScale)
                    .orient('bottom'));
  }

</script>
</body>
</html>
